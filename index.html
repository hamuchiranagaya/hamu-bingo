<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>„ÅØ„ÇÄ„ÉÅ„É©„Éª„Éì„É≥„Ç¥</title>
<style>
:root{--bg:#0f1220;--panel:#181c2f;--text:#fff;--muted:#9fb0c7;--spinSize:min(64vh,64vw)}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif}
body{overflow:hidden}
*,*::before,*::after{box-sizing:border-box}
@media (orientation: portrait){#rotate-tip{display:flex}}@media (orientation: landscape){#rotate-tip{display:none}}
#rotate-tip{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);align-items:center;justify-content:center;text-align:center;padding:24px}

#app{height:100vh;display:grid;grid-template-rows:48px 1fr;gap:8px;padding:8px}
header{background:var(--panel);border-radius:12px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between}
header .title{font-size:clamp(14px,1.8vw,18px);font-weight:700}
button{appearance:none;border:none;border-radius:10px;padding:8px 12px;color:#fff;background:#30365a;font-size:clamp(12px,1.7vw,16px)}
.btn-accent{background:linear-gradient(180deg,#2f6bb0,#204b7b)}.btn-pink{background:linear-gradient(180deg,#b05590,#7b2e57)}.btn-gray{background:linear-gradient(180deg,#3a3f5b,#2a2f49)}
main{display:grid;grid-template-columns:1.2fr .9fr;gap:8px;min-height:0}

.stage{position:relative;border-radius:14px;background:radial-gradient(120% 140% at 50% 0%,#252d5a 0%,#141a33 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);padding:8px;display:grid;place-items:center;overflow:hidden}
.capsule-area{position:relative;width:100%;height:100%;display:grid;place-items:center}
.spinner{width:var(--spinSize);height:var(--spinSize);max-width:520px;max-height:520px;object-fit:contain;filter:drop-shadow(0 20px 30px rgba(0,0,0,.35));opacity:1;transition:opacity .4s ease}
.start-big{width:min(88vh,88vw);height:min(88vh,88vw);max-width:none;max-height:none;}
.spin{animation-name:spinTotal; animation-duration: var(--totalDur,2.4s); animation-timing-function: linear; animation-fill-mode: both;}
.jitter{animation:jitterStrong .6s ease both; animation-iteration-count: 2;}
.fadeout{opacity:0}
@keyframes spinTotal{from{transform:rotate(0)}to{transform:rotate(calc(var(--rotTurns,2) * 1turn))}}
@keyframes jitterStrong{0%{transform:translate(0,0) rotate(0)}10%{transform:translate(4px,-3px) rotate(4deg)}20%{transform:translate(-5px,3px) rotate(-4deg)}30%{transform:translate(6px,2px) rotate(5deg)}40%{transform:translate(-6px,-3px) rotate(-5deg)}50%{transform:translate(5px,2px) rotate(4deg)}60%{transform:translate(-4px,-2px) rotate(-4deg)}70%{transform:translate(3px,2px) rotate(3deg)}80%{transform:translate(-3px,-1px) rotate(-3deg)}90%{transform:translate(2px,1px) rotate(2deg)}100%{transform:translate(0,0) rotate(0)}}

.number-reveal{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:20}
.big-number{font-size:clamp(140px,40vw,520px);font-weight:900;letter-spacing:4px;filter:drop-shadow(0 18px 46px rgba(0,0,0,.5));opacity:0;transform:scale(.7);}
.big-number.visible{opacity:1;}
.show-number{animation:popIn .55s cubic-bezier(.2,.9,.1,1) .05s both}
.big-number.metal{ color: transparent; background: linear-gradient(90deg,#cfcfcf 0%,#fefefe 20%,#c0c0c0 40%,#fefefe 60%,#cfcfcf 80%); -webkit-background-clip: text; background-clip: text;
  -webkit-text-stroke: 1px rgba(255,255,255,.35);
  animation: metalMove 3s linear infinite, metalPulse 2.4s ease-in-out infinite; }
@keyframes metalMove{ from{ background-position: 0% 50%; } to{ background-position: 200% 50%; } }
@keyframes metalPulse{ 0%,100%{ filter: drop-shadow(0 10px 28px rgba(255,255,255,.18)); } 50%{ filter: drop-shadow(0 14px 40px rgba(255,255,255,.32)); } }
@keyframes popIn{0%{opacity:0;transform:scale(.7)}60%{opacity:1;transform:scale(1.08)}100%{opacity:1;transform:scale(1)}}

.panel{display:grid;grid-template-rows:auto 1fr;gap:8px;min-height:0}
.head{background:var(--panel);border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:space-between;gap:6px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.range-info{color:var(--muted);font-size:clamp(12px,1.6vw,14px)}
.grid{background:var(--panel);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:6px;align-content:start;min-height:0;overflow:auto}
.cell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#10142b;color:var(--muted);font-weight:700;font-size:clamp(12px,1.8vw,18px)}
.cell.hit{background:linear-gradient(180deg,#2a8cff,#1650a6);color:#fff;box-shadow:0 0 14px rgba(66,153,255,.35)}

/* Ham popup */
.hamster{position:absolute;right:18px;bottom:18px;display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(0,0,0,.28);border-radius:16px;padding:12px;backdrop-filter:blur(2px);transform:translateY(14px);opacity:0}
.hamster.show{animation:hamIn .4s ease .2s both}
@keyframes hamIn{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}
.hamster .imgbox{ width: clamp(160px, 32vh, 360px); height: clamp(160px, 32vh, 360px); background:#0b0e1e; border-radius: 16px; display:grid; place-items:center; overflow:hidden; }
.hamster img{width:100%;height:100%;object-fit:contain}
.hamster .label{font-size:clamp(14px,1.8vw,18px);color:var(--muted)}

/* FX */
.fx-layer{position:absolute;inset:0;pointer-events:none;overflow:visible;z-index:10}
.flash{position:absolute;left:50%;top:50%;width:0;height:0;transform:translate(-50%,-50%);border-radius:999px;box-shadow:0 0 0 0 rgba(255,255,255,.9)}
.flash.run{animation:flash .5s ease-out both}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(255,255,255,.9)}100%{box-shadow:0 0 120px 160px rgba(255,255,255,0)}}
.shake{animation:shake .4s ease}
@keyframes shake{0%,100%{transform:translate(0,0)}25%{transform:translate(3px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(1px,-1px)}}
.shard,.sparkle{position:absolute;left:50%;top:50%}
.shard{width:10px;height:10px;background:linear-gradient(135deg,#fff8,#ffcbf0);clip-path:polygon(50% 0%,100% 100%,0 100%);filter:drop-shadow(0 3px 6px rgba(0,0,0,.35))}
.sparkle{width:8px;height:8px;background:radial-gradient(circle,#fff,#fff0 70%);border-radius:50%}
.fly{animation:fly var(--dur) cubic-bezier(.2,.9,.1,1) forwards;transform-origin:center}
@keyframes fly{0%{transform:translate(-50%,-50%) rotate(0) scale(.6);opacity:1}80%{opacity:1}100%{transform:translate(calc(-50% + var(--dx)),calc(-50% + var(--dy))) rotate(var(--rot)) scale(1);opacity:0}}

/* Settings */
.settings{position:fixed;right:10px;top:56px;z-index:50;background:var(--panel);border-radius:12px;padding:10px;display:none;min-width:260px}
.settings.show{display:block}
.settings label{font-size:14px;color:var(--muted)}
.settings .row{display:flex;align-items:center;gap:8px;margin:6px 0}
.small{opacity:.8}

/* Name editor modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:70}
.modal.show{display:flex}
.modal .box{background:#151935;border-radius:14px;padding:14px;min-width:min(92vw,720px);max-width:96vw;color:#e5edff;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.modal .title{font-weight:700;margin:4px 0 10px 0}
.modal .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.modal .row{display:flex;gap:8px;align-items:center}
.modal input[type="text"]{flex:1;background:#0e1230;border:1px solid #2a3157;border-radius:8px;color:#fff;padding:8px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Celebration FX */
.rays{position:absolute;left:50%;top:50%;width:160vmax;height:160vmax;transform:translate(-50%,-50%) scale(.6);background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.28) 0 3deg, transparent 3deg 14deg);filter:blur(0.5px) drop-shadow(0 0 18px rgba(255,255,255,.25));opacity:0;pointer-events:none;z-index:9;border-radius:50%}
.rays.run{animation:raysBurst .6s ease-out both}
@keyframes raysBurst{0%{opacity:0;transform:translate(-50%,-50%) scale(.4) rotate(0)}70%{opacity:.9}100%{opacity:0;transform:translate(-50%,-50%) scale(1.15) rotate(8deg)}}

.petal{position:absolute;width:12px;height:18px;border-radius:12px 12px 2px 12px;opacity:0;pointer-events:none;z-index:11;mix-blend-mode:screen}
@keyframes petalFall{0%{transform:translate(var(--sx),-60vh) rotate(0deg) scale(.9);opacity:0}
10%{opacity:.9}
50%{transform:translate(calc(var(--sx) + var(--dx)),20vh) rotate(180deg) scale(1)}
100%{transform:translate(calc(var(--sx) + var(--dx)*2),70vh) rotate(360deg) scale(1);opacity:0}}

</style>
</head>
<body>
<div id="rotate-tip"><div><div style="font-size:18px;margin-bottom:10px;">„Çπ„Éû„Éõ„ÇíÊ®™Âêë„Åç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑüì±‚ÜîÔ∏è</div><div style="font-size:14px;color:#cbd5e1;">Ôºà2„Äú3ÂõûËª¢‚Üí„ÅØ„Åò„Åë‚Üí„É°„Çø„É™„ÉÉ„ÇØÊï∞Â≠ó‚ú®Ôºâ</div></div></div>

<div id="app">
<header>
  <div class="title">„ÅØ„ÇÄ„ÉÅ„É©„Éª„Éì„É≥„Ç¥</div>
  <div class="controls">
    <button class="btn-gray" id="fsBtn">ÂÖ®ÁîªÈù¢</button>
    <button class="btn-gray" id="sfxBtn">ÂäπÊûúÈü≥: <span id="sfxState">ON</span></button>
    <button class="btn-gray" id="nameBtn">ÂêçÂâç</button>
    <button class="btn-gray" id="settingsBtn">Ë®≠ÂÆö</button>
  </div>
</header>

<main>
<section class="stage" id="stage">
  <div class="capsule-area">
    <img id="spinner" class="spinner start-big" src="assets/start.png" alt="Start"/>
    <div class="number-reveal"><div class="big-number" id="bigNumber"></div></div>
    <div class="hamster" id="hamBox">
      <div class="imgbox"><img id="hamImg" src="assets/ham_01.png" alt="Ham"/></div>
      <div class="label" id="hamLabel">ÁôªÂ†¥„Éè„É†Ôºö#01</div>
    </div>
    <div class="fx-layer" id="fx"></div>
  </div>
</section>
<section class="panel">
  <div class="head">
    <div class="range-info">Áï™Âè∑ÁØÑÂõ≤Ôºö1„Äú75ÔºàÈáçË§á„Å™„ÅóÔºâ</div>
    <div class="actions">
      <button class="btn-accent" id="drawBtn">ÊäΩÈÅ∏</button>
      <button class="btn-gray" id="undoBtn">1ÊâãÊàª„Åô</button>
      <button class="btn-pink" id="resetBtn">„É™„Çª„ÉÉ„Éà</button>
    </div>
  </div>
  <div id="historyGrid" class="grid"></div>
</section>
</main>
</div>

<div class="settings" id="settings">
  <div class="row"><label>„Çπ„Éî„Éä„Éº„ÅÆÂ§ß„Åç„ÅïÔºö</label>
    <button class="btn-gray" data-size="min(54vh,54vw)">Â∞è</button>
    <button class="btn-gray" data-size="min(64vh,64vw)">‰∏≠</button>
    <button class="btn-gray" data-size="min(72vh,72vw)">Â§ß</button>
  </div>
  <div class="row"><label>ÂõûËª¢ÂõûÊï∞Ôºö</label>
    <button class="btn-gray" data-rot="2">2ÂõûËª¢</button>
    <button class="btn-gray" data-rot="3">3ÂõûËª¢</button>
    <span class="small" id="rotHint">(ÁèæÂú®: <b id="rotVal">2</b>)</span>
  </div>
  <div class="row"><label>Èü≥ÈáèÔºö</label>
    <button class="btn-gray" data-vol="0.5">Â∞è</button>
    <button class="btn-gray" data-vol="0.8">‰∏≠</button>
    <button class="btn-gray" data-vol="1.0">Â§ß</button>
  </div>
</div>

<!-- Name editor modal -->
<div class="modal" id="nameModal">
  <div class="box">
    <div class="title">„Éè„É†„ÅÆÂêçÂâçÔºà#01„Äú#10Ôºâ</div>
    <div class="grid" id="nameGrid"></div>
    <div class="actions">
      <button class="btn-gray" id="nameCancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn-accent" id="nameSave">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<script>
(()=>{
const TOTAL=75;
const hamImages=Array.from({length:10},(_,i)=>`assets/ham_${String(i+1).padStart(2,'0')}.png`);
const ketsuImages=Array.from({length:10},(_,i)=>`assets/ketsu_${String(i+1).padStart(2,'0')}.png`);
const state={pool:[],history:[],animBusy:false,sfx:true,spinSize:"min(64vh,64vw)",rotations:2,volume:0.8};
const $=id=>document.getElementById(id);
const el={grid:$("historyGrid"),draw:$("drawBtn"),undo:$("undoBtn"),reset:$("resetBtn"),
bigNumber:$("bigNumber"),hamImg:$("hamImg"),hamLabel:$("hamLabel"),hamBox:$("hamBox"),
stage:$("stage"),fx:$("fx"),spinner:$("spinner"),
fsBtn:$("fsBtn"),sfxBtn:$("sfxBtn"),sfxState:$("sfxState"),settingsBtn:$("settingsBtn"),settings:$("settings"),rotVal:$("rotVal")};

function initPool(){state.pool=Array.from({length:TOTAL},(_,i)=>i+1)}
function buildGrid(){el.grid.innerHTML="";for(let i=1;i<=TOTAL;i++){const d=document.createElement("div");d.className="cell";d.textContent=i;d.id=`cell-${i}`;el.grid.appendChild(d)}}
function markGrid(n,on){const c=document.getElementById(`cell-${n}`);if(c)c.classList.toggle("hit",!!on)}
function sample(arr){return arr[Math.floor(Math.random()*arr.length)]}

function flash(){const d=document.createElement("div");d.className="flash run";el.fx.appendChild(d);setTimeout(()=>d.remove(),520)}
function shake(){el.stage.classList.add("shake");setTimeout(()=>el.stage.classList.remove("shake"),420)}
function burstShards(count=20){for(let i=0;i<count;i++){const shard=document.createElement("div");shard.className="shard fly";const ang=Math.random()*2*Math.PI;const dist=90+Math.random()*150;const dx=Math.cos(ang)*dist;const dy=Math.sin(ang)*dist;shard.style.setProperty("--dx",dx+"px");shard.style.setProperty("--dy",dy+"px");shard.style.setProperty("--rot",(Math.random()*540-270)+"deg");shard.style.setProperty("--dur",(0.7+Math.random()*0.6)+'s');el.fx.appendChild(shard);setTimeout(()=>shard.remove(),1500)}}
function burstSparkles(count=26){for(let i=0;i<count;i++){const sp=document.createElement("div");sp.className="sparkle fly";const ang=Math.random()*2*Math.PI;const dist=70+Math.random()*200;const dx=Math.cos(ang)*dist;const dy=Math.sin(ang)*dist;sp.style.setProperty("--dx",dx+'px');sp.style.setProperty("--dy",dy+'px');sp.style.setProperty("--rot",(Math.random()*180-90)+'deg');sp.style.setProperty("--dur",(0.8+Math.random()*0.6)+'s');el.fx.appendChild(sp);setTimeout(()=>sp.remove(),1600)}}

/* WebAudio */
let audioCtx=null, rollTimer=null;
function ensureAudio(){ if(!state.sfx) return null; if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ return null; } } return audioCtx; }
function playCrackSfx(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(520, now); g.gain.setValueAtTime(0.001, now); g.gain.exponentialRampToValueAtTime(0.22*state.volume, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.25); o.frequency.exponentialRampToValueAtTime(220, now+0.25); o.connect(g).connect(ctx.destination); o.start(now); o.stop(now+0.26); }
function playRollingTick(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(900, now); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.12*state.volume, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+0.05); o.connect(g).connect(ctx.destination); o.start(now); o.stop(now+0.06); }
function startRollingSfx(){ if(!state.sfx) return; stopRollingSfx(); rollTimer=setInterval(playRollingTick, 100); }
function stopRollingSfx(){ if(rollTimer){ clearInterval(rollTimer); rollTimer=null; } }
function playRevealSfx(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const buffer=ctx.createBuffer(1,44100,44100); const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.5; const src=ctx.createBufferSource(); src.buffer=buffer; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(600, now); const wg=ctx.createGain(); wg.gain.setValueAtTime(0.0001, now); wg.gain.exponentialRampToValueAtTime(0.25*state.volume, now+0.06); wg.gain.exponentialRampToValueAtTime(0.0001, now+0.35); bp.frequency.exponentialRampToValueAtTime(2000, now+0.32); src.connect(bp).connect(wg).connect(ctx.destination); src.start(now); src.stop(now+0.36); const freqs=[523.25,659.25,783.99]; freqs.forEach((f,i)=>{ const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f, now+0.02*i); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime((0.18 - i*0.03)*state.volume, now+0.05+0.02*i); g.gain.exponentialRampToValueAtTime(0.0001, now+0.6+0.05*i); o.connect(g).connect(ctx.destination); o.start(now+0.02*i); o.stop(now+0.7+0.05*i); }); }

function showStart(){ el.spinner.src='assets/start.png'; el.spinner.classList.add('start-big'); el.bigNumber.classList.remove('visible','metal','show-number'); el.bigNumber.textContent=''; el.hamBox.classList.remove('show'); }

/* Flow */
async function drawOnce(){
  if(state.animBusy) return;
  if(state.pool.length===0){ alert('„Åô„Åπ„Å¶„ÅÆÁï™Âè∑„ÅåÂá∫„Åæ„Åó„ÅüÔºÅ'); return; }
  state.animBusy = true;

  // hide previous number & ham right away; exit start-big
  el.bigNumber.classList.remove('visible','metal','show-number');
  el.hamBox.classList.remove('show');
  el.spinner.classList.remove('start-big');

  const n = sample(state.pool); state.pool = state.pool.filter(x=>x!==n); state.history.push(n);

  const kid = Math.floor(Math.random()*10);
  el.spinner.src = ketsuImages[kid];
  el.spinner.classList.remove('spin','jitter','fadeout');
  el.spinner.style.setProperty('--rotTurns', state.rotations.toString());
  el.spinner.style.setProperty('--totalDur', (state.rotations*1.2)+'s');
  void el.spinner.offsetWidth;

  startRollingSfx();
  el.spinner.classList.add('spin');
  await new Promise(r=>setTimeout(r, Math.round(state.rotations*1200)));
  el.spinner.classList.add('jitter');
  await new Promise(r=>setTimeout(r, 600));
  stopRollingSfx();

  el.spinner.classList.add('fadeout');
  flash(); shake(); burstShards(); burstSparkles(); playCrackSfx();

  // Number persists
  el.bigNumber.classList.remove('show-number','metal'); el.bigNumber.classList.add('visible'); void el.bigNumber.offsetWidth;
  el.bigNumber.textContent = n; el.bigNumber.classList.add('show-number');
  setTimeout(()=>{ el.bigNumber.classList.add('metal'); }, 100);

  // Matched ham popup
  el.hamImg.src = hamImages[kid]; el.hamLabel.dataset.index = kid; el.hamLabel.textContent = labelFor(kid);
  el.hamBox.classList.remove('show'); void el.hamBox.offsetWidth; el.hamBox.classList.add('show');

  playRevealSfx(); rays(); petals(70);
  markGrid(n,true);
  save();
  state.animBusy=false;
}

function undo(){ if(state.animBusy) return; const last=state.history.pop(); if(last==null) return; state.pool.push(last); markGrid(last,false); el.bigNumber.classList.remove('metal'); if(state.history.length){el.bigNumber.textContent=state.history[state.history.length-1]; el.bigNumber.classList.add('visible');} else {el.bigNumber.textContent=''; el.bigNumber.classList.remove('visible'); showStart(); } save(); }
function reset(){ if(state.animBusy) return; if(!confirm('„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return; initPool(); state.history=[]; buildGrid(); el.bigNumber.classList.remove('metal'); el.bigNumber.textContent=''; el.bigNumber.classList.remove('visible'); el.hamBox.classList.remove('show'); el.spinner.classList.remove('spin','jitter','fadeout'); showStart(); save(); }

/* storage */
const KEY='ham_bingo_state_v6_11';
function save(){ try{ localStorage.setItem(KEY, JSON.stringify({pool:state.pool,history:state.history,sfx:state.sfx,spinSize:state.spinSize,rotations:state.rotations,volume:state.volume})); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return false; const d=JSON.parse(raw); if(!Array.isArray(d.pool)||!Array.isArray(d.history)) return false; state.pool=d.pool; state.history=d.history; state.sfx=d.sfx ?? true; state.spinSize=d.spinSize ?? state.spinSize; state.rotations=d.rotations ?? 2; state.volume=d.volume ?? 0.8; return true; }catch(e){ return false; } }


/* Names storage */
const NKEY='ham_names_v6_12';
function loadNames(){
  try{ const raw=localStorage.getItem(NKEY); if(!raw) return Array(10).fill(''); const arr=JSON.parse(raw); if(!Array.isArray(arr)||arr.length!==10) return Array(10).fill(''); return arr.map(x=>x||''); }catch(e){ return Array(10).fill(''); }
}
function saveNames(arr){ try{ localStorage.setItem(NKEY, JSON.stringify(arr)); }catch(e){} }
let hamNames = loadNames();

function labelFor(index){ // index: 0..9
  const name = (hamNames[index]||'').trim();
  if(name) return name;
  return `ÁôªÂ†¥„Éè„É†Ôºö#${String(index+1).padStart(2,'0')}`;
}

/* Name modal UI */
const nameModal = document.getElementById('nameModal');
const nameGrid = document.getElementById('nameGrid');
function openNameModal(){
  nameGrid.innerHTML='';
  for(let i=0;i<10;i++){
    const row=document.createElement('div'); row.className='row';
    const lab=document.createElement('div'); lab.style.width='62px'; lab.textContent='#'+String(i+1).padStart(2,'0');
    const inp=document.createElement('input'); inp.type='text'; inp.value=hamNames[i]||''; inp.placeholder=`‰æãÔºâ„Åì„Å£„Åü`; inp.dataset.idx=i;
    row.appendChild(lab); row.appendChild(inp); nameGrid.appendChild(row);
  }
  nameModal.classList.add('show');
}
function closeNameModal(){ nameModal.classList.remove('show'); }
document.getElementById('nameBtn').addEventListener('click', openNameModal);
document.getElementById('nameCancel').addEventListener('click', closeNameModal);
document.getElementById('nameSave').addEventListener('click', ()=>{
  const inputs=[...nameGrid.querySelectorAll('input')];
  inputs.forEach(inp=>{ const i=parseInt(inp.dataset.idx); hamNames[i]=inp.value; });
  saveNames(hamNames); closeNameModal();
  // refresh current label if visible
  const txt = el.hamLabel.dataset.index ? labelFor(parseInt(el.hamLabel.dataset.index)) : '';
  if(txt) el.hamLabel.textContent = txt;
});

/* Celebration FX */
function rays(){ const r=document.createElement('div'); r.className='rays run'; el.fx.appendChild(r); setTimeout(()=>r.remove(), 700); }
const petalColors=['#ffd7e5','#ffe9a6','#d6fff0','#ffe6f2','#e1ffd7','#fff8cc'];
function petals(count=60){
  for(let i=0;i<count;i++){
    const p=document.createElement('div'); p.className='petal';
    const col = petalColors[Math.floor(Math.random()*petalColors.length)];
    p.style.background=col;
    p.style.left='50%'; p.style.top='0';
    const sx = (Math.random()*120-60)+'vw'; // start x offset from center
    const dx = (Math.random()*20-10)+'vw'; // drift per half fall
    p.style.setProperty('--sx', sx); p.style.setProperty('--dx', dx);
    p.style.animation=`petalFall ${0.9 + Math.random()*0.8}s ease-out ${Math.random()*0.2}s both`;
    el.fx.appendChild(p);
    setTimeout(()=>p.remove(), 1800);
  }
}

/* UI */
el.fsBtn.addEventListener('click', async ()=>{const docEl=document.documentElement;if(!document.fullscreenElement)await docEl.requestFullscreen().catch(()=>{});else await document.exitFullscreen().catch(()=>{})});
el.sfxBtn.addEventListener('click', ()=>{state.sfx=!state.sfx;el.sfxState.textContent=state.sfx?'ON':'OFF';save()});
el.settingsBtn.addEventListener('click', ()=>{el.settings.classList.toggle('show')});
el.settings.querySelectorAll('button[data-size]').forEach(b=>b.addEventListener('click',()=>{state.spinSize=b.getAttribute('data-size');document.documentElement.style.setProperty('--spinSize',state.spinSize);save()}));
el.settings.querySelectorAll('button[data-rot]').forEach(b=>b.addEventListener('click',()=>{state.rotations=parseInt(b.getAttribute('data-rot')); el.rotVal.textContent=state.rotations; save()}));
el.settings.querySelectorAll('button[data-vol]').forEach(b=>b.addEventListener('click',()=>{state.volume=parseFloat(b.getAttribute('data-vol')); save()}));

el.draw.addEventListener('click', drawOnce);
el.undo.addEventListener('click', undo);
el.reset.addEventListener('click', reset);

/* init */
function init(){ buildGrid(); if(!load()) initPool(); state.history.forEach(n=>markGrid(n,true)); if(state.history.length){ el.bigNumber.textContent=state.history[state.history.length-1]; el.bigNumber.classList.add('visible'); el.spinner.classList.remove('start-big'); el.spinner.src='assets/ketsu_01.png'; } else { showStart(); } el.sfxState.textContent=state.sfx ? 'ON' : 'OFF'; document.documentElement.style.setProperty('--spinSize', state.spinSize); el.rotVal.textContent = state.rotations;}
init();
})();
</script>
</body>
</html>
