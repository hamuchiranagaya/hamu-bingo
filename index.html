<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>はむチラ・ビンゴ</title>
<style>
:root{--bg:#0f1220;--panel:#181c2f;--text:#fff;--muted:#9fb0c7;--spinSize:min(64vh,64vw)}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif}
body{overflow:hidden}
*,*::before,*::after{box-sizing:border-box}
@media (orientation: portrait){#rotate-tip{display:flex}}@media (orientation: landscape){#rotate-tip{display:none}}
#rotate-tip{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);align-items:center;justify-content:center;text-align:center;padding:24px}

#app{height:100vh;display:grid;grid-template-rows:48px 1fr 42px;gap:8px;padding:8px}
header,footer{background:var(--panel);border-radius:12px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between}
header .title{font-size:clamp(14px,1.8vw,18px);font-weight:700}
button{appearance:none;border:none;border-radius:10px;padding:8px 12px;color:#fff;background:#30365a;font-size:clamp(12px,1.7vw,16px)}
.btn-accent{background:linear-gradient(180deg,#2f6bb0,#204b7b)}.btn-pink{background:linear-gradient(180deg,#b05590,#7b2e57)}.btn-gray{background:linear-gradient(180deg,#3a3f5b,#2a2f49)}
main{display:grid;grid-template-columns:1.2fr .9fr;gap:8px;min-height:0}

.stage{position:relative;border-radius:14px;background:radial-gradient(120% 140% at 50% 0%,#252d5a 0%,#141a33 60%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);padding:8px;display:grid;place-items:center;overflow:hidden}
.capsule-area{position:relative;width:100%;height:100%;display:grid;place-items:center}
.spinner{width:var(--spinSize);height:var(--spinSize);max-width:520px;max-height:520px;object-fit:contain;filter:drop-shadow(0 20px 30px rgba(0,0,0,.35));opacity:1;transition:opacity .4s ease}
.spin{animation-name:spinTotal; animation-duration: var(--totalDur,2.4s); animation-timing-function: linear; animation-fill-mode: both;}
.jitter{animation:jitter .35s ease both}
.fadeout{opacity:0}
@keyframes spinTotal{from{transform:rotate(0)}to{transform:rotate(calc(var(--rotTurns,2) * 1turn))}}
@keyframes jitter{0%{transform:rotate(0)}25%{transform:rotate(4deg)}50%{transform:rotate(-3deg)}75%{transform:rotate(2deg)}100%{transform:rotate(0)}}

.number-reveal{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:20}
.big-number{font-size:clamp(64px,12vw,160px);font-weight:900;letter-spacing:2px;filter:drop-shadow(0 12px 30px rgba(0,0,0,.45));opacity:0;transform:scale(.7);}
.show-number{animation:popIn .55s cubic-bezier(.2,.9,.1,1) .05s both}
.big-number.metal{ color: transparent; background: linear-gradient(90deg,#cfcfcf 0%,#fefefe 20%,#c0c0c0 40%,#fefefe 60%,#cfcfcf 80%); -webkit-background-clip: text; background-clip: text;
  -webkit-text-stroke: 1px rgba(255,255,255,.35);
  animation: metalMove 3s linear infinite, metalPulse 2.4s ease-in-out infinite; }
@keyframes metalMove{ from{ background-position: 0% 50%; } to{ background-position: 200% 50%; } }
@keyframes metalPulse{ 0%,100%{ filter: drop-shadow(0 10px 28px rgba(255,255,255,.18)); } 50%{ filter: drop-shadow(0 14px 40px rgba(255,255,255,.32)); } }
@keyframes popIn{0%{opacity:0;transform:scale(.7)}60%{opacity:1;transform:scale(1.08)}100%{opacity:1;transform:scale(1)}}

.panel{display:grid;grid-template-rows:auto 1fr;gap:8px;min-height:0}
.head{background:var(--panel);border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:space-between;gap:6px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.range-info{color:var(--muted);font-size:clamp(12px,1.6vw,14px)}
.grid{background:var(--panel);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:6px;align-content:start;min-height:0;overflow:auto}
.cell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#10142b;color:var(--muted);font-weight:700;font-size:clamp(12px,1.8vw,18px)}
.cell.hit{background:linear-gradient(180deg,#2a8cff,#1650a6);color:#fff;box-shadow:0 0 14px rgba(66,153,255,.35)}

.hamster{position:absolute;right:10px;bottom:10px;display:flex;flex-direction:column;align-items:center;gap:6px;background:rgba(0,0,0,.3);border-radius:12px;padding:8px;backdrop-filter:blur(2px);transform:translateY(14px);opacity:0}
.hamster.show{animation:hamIn .4s ease .2s both}
@keyframes hamIn{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}
.hamster .imgbox{ width: clamp(88px, 18vh, 180px); height: clamp(88px, 18vh, 180px); background:#0b0e1e; border-radius: 12px; display:grid; place-items:center; overflow:hidden; }
.hamster img{width:100%;height:100%;object-fit:contain}
.hamster .label{font-size:clamp(12px,1.6vw,14px);color:var(--muted)}

/* FX */
.fx-layer{position:absolute;inset:0;pointer-events:none;overflow:visible;z-index:10}
.flash{position:absolute;left:50%;top:50%;width:0;height:0;transform:translate(-50%,-50%);border-radius:999px;box-shadow:0 0 0 0 rgba(255,255,255,.9)}
.flash.run{animation:flash .5s ease-out both}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(255,255,255,.9)}100%{box-shadow:0 0 120px 160px rgba(255,255,255,0)}}
.shake{animation:shake .4s ease}
@keyframes shake{0%,100%{transform:translate(0,0)}25%{transform:translate(3px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(1px,-1px)}}
.shard,.sparkle{position:absolute;left:50%;top:50%}
.shard{width:10px;height:10px;background:linear-gradient(135deg,#fff8,#ffcbf0);clip-path:polygon(50% 0%,100% 100%,0 100%);filter:drop-shadow(0 3px 6px rgba(0,0,0,.35))}
.sparkle{width:8px;height:8px;background:radial-gradient(circle,#fff,#fff0 70%);border-radius:50%}
.fly{animation:fly var(--dur) cubic-bezier(.2,.9,.1,1) forwards;transform-origin:center}
@keyframes fly{0%{transform:translate(-50%,-50%) rotate(0) scale(.6);opacity:1}80%{opacity:1}100%{transform:translate(calc(-50% + var(--dx)),calc(-50% + var(--dy))) rotate(var(--rot)) scale(1);opacity:0}}

/* Settings */
.settings{position:fixed;right:10px;top:56px;z-index:50;background:var(--panel);border-radius:12px;padding:10px;display:none;min-width:260px}
.settings.show{display:block}
.settings label{font-size:14px;color:var(--muted)}
.settings .row{display:flex;align-items:center;gap:8px;margin:6px 0}
.small{opacity:.8}
</style>
</head>
<body>
<div id="rotate-tip"><div><div style="font-size:18px;margin-bottom:10px;">スマホを横向きにしてください📱↔️</div><div style="font-size:14px;color:#cbd5e1;">（2〜3回転→はじけ→メタリック数字✨）</div></div></div>

<div id="app">
<header>
  <div class="title">はむチラ・ビンゴ</div>
  <div class="controls">
    <button class="btn-gray" id="fsBtn">全画面</button>
    <button class="btn-gray" id="sfxBtn">効果音: <span id="sfxState">ON</span></button>
    <button class="btn-gray" id="settingsBtn">設定</button>
  </div>
</header>

<main>
<section class="stage" id="stage">
  <div class="capsule-area">
    <img id="spinner" class="spinner" src="assets/ketsu_01.png" alt="HamKetsu"/>
    <div class="number-reveal"><div class="big-number" id="bigNumber">--</div></div>
    <div class="hamster" id="hamBox">
      <div class="imgbox"><img id="hamImg" src="assets/ham_01.png" alt="Ham"/></div>
      <div class="label" id="hamLabel">登場ハム：#01</div>
    </div>
    <div class="fx-layer" id="fx"></div>
  </div>
</section>
<section class="panel">
  <div class="head">
    <div class="range-info">番号範囲：1〜75（重複なし）</div>
    <div class="actions">
      <button class="btn-accent" id="drawBtn">抽選</button>
      <button class="btn-gray" id="undoBtn">1手戻す</button>
      <button class="btn-pink" id="resetBtn">リセット</button>
    </div>
  </div>
  <div id="historyGrid" class="grid"></div>
</section>
</main>

<footer><div class="hint small">差し替え：はむケツ→ assets/ketsu_01.png〜ketsu_10.png（透過PNG）／ ハム→ assets/ham_01.png〜ham_10.png（正方形推奨）</div></footer>
</div>

<div class="settings" id="settings">
  <div class="row"><label>スピナーの大きさ：</label>
    <button class="btn-gray" data-size="min(54vh,54vw)">小</button>
    <button class="btn-gray" data-size="min(64vh,64vw)">中</button>
    <button class="btn-gray" data-size="min(72vh,72vw)">大</button>
  </div>
  <div class="row"><label>回転回数：</label>
    <button class="btn-gray" data-rot="2">2回転</button>
    <button class="btn-gray" data-rot="3">3回転</button>
    <span class="small" id="rotHint">(現在: <b id="rotVal">2</b>)</span>
  </div>
  <div class="row"><label>音量：</label>
    <button class="btn-gray" data-vol="0.5">小</button>
    <button class="btn-gray" data-vol="0.8">中</button>
    <button class="btn-gray" data-vol="1.0">大</button>
  </div>
</div>

<script>
(()=>{
const TOTAL=75;
const hamImages=Array.from({length:10},(_,i)=>`assets/ham_${String(i+1).padStart(2,'0')}.png`);
const ketsuImages=Array.from({length:10},(_,i)=>`assets/ketsu_${String(i+1).padStart(2,'0')}.png`);
const state={pool:[],history:[],lastHamIndex:-1,animBusy:false,sfx:true,spinSize:"min(64vh,64vw)",rotations:2,volume:0.8};
const $=id=>document.getElementById(id);
const el={grid:$("historyGrid"),draw:$("drawBtn"),undo:$("undoBtn"),reset:$("resetBtn"),
bigNumber:$("bigNumber"),hamImg:$("hamImg"),hamLabel:$("hamLabel"),hamBox:$("hamBox"),
stage:$("stage"),fx:$("fx"),spinner:$("spinner"),
fsBtn:$("fsBtn"),sfxBtn:$("sfxBtn"),sfxState:$("sfxState"),settingsBtn:$("settingsBtn"),settings:$("settings"),rotVal:$("rotVal")};

function initPool(){state.pool=Array.from({length:TOTAL},(_,i)=>i+1)}
function buildGrid(){el.grid.innerHTML="";for(let i=1;i<=TOTAL;i++){const d=document.createElement("div");d.className="cell";d.textContent=i;d.id=`cell-${i}`;el.grid.appendChild(d)}}
function markGrid(n,on){const c=document.getElementById(`cell-${n}`);if(c)c.classList.toggle("hit",!!on)}
function sample(arr){return arr[Math.floor(Math.random()*arr.length)]}
function randomHamIndex(){let idx;do{idx=Math.floor(Math.random()*hamImages.length)}while(hamImages.length>1&&idx===state.lastHamIndex);state.lastHamIndex=idx;return idx}

function flash(){const d=document.createElement("div");d.className="flash run";el.fx.appendChild(d);setTimeout(()=>d.remove(),520)}
function shake(){el.stage.classList.add("shake");setTimeout(()=>el.stage.classList.remove("shake"),420)}
function burstShards(count=20){for(let i=0;i<count;i++){const shard=document.createElement("div");shard.className="shard fly";const ang=Math.random()*2*Math.PI;const dist=90+Math.random()*150;const dx=Math.cos(ang)*dist;const dy=Math.sin(ang)*dist;shard.style.setProperty("--dx",dx+"px");shard.style.setProperty("--dy",dy+"px");shard.style.setProperty("--rot",(Math.random()*540-270)+"deg");shard.style.setProperty("--dur",(0.7+Math.random()*0.6)+'s');el.fx.appendChild(shard);setTimeout(()=>shard.remove(),1500)}}
function burstSparkles(count=26){for(let i=0;i<count;i++){const sp=document.createElement("div");sp.className="sparkle fly";const ang=Math.random()*2*Math.PI;const dist=70+Math.random()*200;const dx=Math.cos(ang)*dist;const dy=Math.sin(ang)*dist;sp.style.setProperty("--dx",dx+'px');sp.style.setProperty("--dy",dy+'px');sp.style.setProperty("--rot",(Math.random()*180-90)+'deg');sp.style.setProperty("--dur",(0.8+Math.random()*0.6)+'s');el.fx.appendChild(sp);setTimeout(()=>sp.remove(),1600)}}

/* WebAudio */
let audioCtx=null, rollTimer=null;
function ensureAudio(){ if(!state.sfx) return null; if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ return null; } } return audioCtx; }
function playCrackSfx(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(520, now); g.gain.setValueAtTime(0.001, now); g.gain.exponentialRampToValueAtTime(0.22*state.volume, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.25); o.frequency.exponentialRampToValueAtTime(220, now+0.25); o.connect(g).connect(ctx.destination); o.start(now); o.stop(now+0.26); }
function playRollingTick(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(900, now); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.12*state.volume, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+0.05); o.connect(g).connect(ctx.destination); o.start(now); o.stop(now+0.06); }
function startRollingSfx(){ if(!state.sfx) return; stopRollingSfx(); rollTimer=setInterval(playRollingTick, 100); }
function stopRollingSfx(){ if(rollTimer){ clearInterval(rollTimer); rollTimer=null; } }
function playRevealSfx(){ const ctx=ensureAudio(); if(!ctx) return; const now=ctx.currentTime; const buffer=ctx.createBuffer(1,44100,44100); const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.5; const src=ctx.createBufferSource(); src.buffer=buffer; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(600, now); const wg=ctx.createGain(); wg.gain.setValueAtTime(0.0001, now); wg.gain.exponentialRampToValueAtTime(0.25*state.volume, now+0.06); wg.gain.exponentialRampToValueAtTime(0.0001, now+0.35); bp.frequency.exponentialRampToValueAtTime(2000, now+0.32); src.connect(bp).connect(wg).connect(ctx.destination); src.start(now); src.stop(now+0.36); const freqs=[523.25,659.25,783.99]; freqs.forEach((f,i)=>{ const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f, now+0.02*i); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime((0.18 - i*0.03)*state.volume, now+0.05+0.02*i); g.gain.exponentialRampToValueAtTime(0.0001, now+0.6+0.05*i); o.connect(g).connect(ctx.destination); o.start(now+0.02*i); o.stop(now+0.7+0.05*i); }); }

/* Flow */
async function drawOnce(){
  if(state.animBusy) return;
  if(state.pool.length===0){ alert('すべての番号が出ました！'); return; }
  state.animBusy = true;

  const n = sample(state.pool); state.pool = state.pool.filter(x=>x!==n); state.history.push(n);

  const kid = Math.floor(Math.random()*ketsuImages.length);
  el.spinner.src = ketsuImages[kid];
  el.spinner.classList.remove('spin','jitter','fadeout');
  el.spinner.style.setProperty('--rotTurns', state.rotations.toString());
  el.spinner.style.setProperty('--totalDur', (state.rotations*1.2)+'s');
  void el.spinner.offsetWidth;

  startRollingSfx();
  el.spinner.classList.add('spin');
  await new Promise(r=>setTimeout(r, Math.round(state.rotations*1200)));
  el.spinner.classList.add('jitter');
  await new Promise(r=>setTimeout(r, 350));
  stopRollingSfx();

  el.spinner.classList.add('fadeout');
  flash(); shake(); burstShards(); burstSparkles(); playCrackSfx();

  el.bigNumber.classList.remove('show-number','metal'); void el.bigNumber.offsetWidth;
  el.bigNumber.textContent = n; el.bigNumber.classList.add('show-number');
  setTimeout(()=>{ el.bigNumber.classList.add('metal'); }, 100);

  const hidx = randomHamIndex(); el.hamImg.src = hamImages[hidx]; el.hamLabel.textContent = `登場ハム：#${String(hidx+1).padStart(2,'0')}`;
  el.hamBox.classList.remove('show'); void el.hamBox.offsetWidth; el.hamBox.classList.add('show');

  playRevealSfx();
  markGrid(n,true);
  save();
  state.animBusy=false;
}

function undo(){ if(state.animBusy) return; const last=state.history.pop(); if(last==null) return; state.pool.push(last); markGrid(last,false); el.bigNumber.classList.remove('metal'); el.bigNumber.textContent=state.history[state.history.length-1] ?? '--'; save(); }
function reset(){ if(state.animBusy) return; if(!confirm('すべてリセットしますか？')) return; initPool(); state.history=[]; buildGrid(); el.bigNumber.classList.remove('metal'); el.bigNumber.textContent='--'; save(); }

/* storage */
const KEY='ham_bingo_state_v6_7';
function save(){ try{ localStorage.setItem(KEY, JSON.stringify({pool:state.pool,history:state.history,lastHamIndex:state.lastHamIndex,sfx:state.sfx,spinSize:state.spinSize,rotations:state.rotations,volume:state.volume})); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return false; const d=JSON.parse(raw); if(!Array.isArray(d.pool)||!Array.isArray(d.history)) return false; state.pool=d.pool; state.history=d.history; state.lastHamIndex=d.lastHamIndex ?? -1; state.sfx=d.sfx ?? true; state.spinSize=d.spinSize ?? state.spinSize; state.rotations=d.rotations ?? 2; state.volume=d.volume ?? 0.8; return true; }catch(e){ return false; } }

/* UI */
el.fsBtn.addEventListener('click', async ()=>{const docEl=document.documentElement;if(!document.fullscreenElement)await docEl.requestFullscreen().catch(()=>{});else await document.exitFullscreen().catch(()=>{})});
el.sfxBtn.addEventListener('click', ()=>{state.sfx=!state.sfx;el.sfxState.textContent=state.sfx?'ON':'OFF';save()});
el.settingsBtn.addEventListener('click', ()=>{el.settings.classList.toggle('show')});
el.settings.querySelectorAll('button[data-size]').forEach(b=>b.addEventListener('click',()=>{state.spinSize=b.getAttribute('data-size');document.documentElement.style.setProperty('--spinSize',state.spinSize);save()}));
el.settings.querySelectorAll('button[data-rot]').forEach(b=>b.addEventListener('click',()=>{state.rotations=parseInt(b.getAttribute('data-rot')); el.rotVal.textContent=state.rotations; save()}));
el.settings.querySelectorAll('button[data-vol]').forEach(b=>b.addEventListener('click',()=>{state.volume=parseFloat(b.getAttribute('data-vol')); save()}));

el.draw.addEventListener('click', drawOnce);
el.undo.addEventListener('click', undo);
el.reset.addEventListener('click', reset);

/* init */
buildGrid();
if(!load()) initPool();
state.history.forEach(n=>markGrid(n,true));
el.bigNumber.textContent=state.history[state.history.length-1] ?? '--';
el.sfxState.textContent=state.sfx ? 'ON' : 'OFF';
document.documentElement.style.setProperty('--spinSize', state.spinSize);
el.rotVal.textContent = state.rotations;
})();
</script>
</body>
</html>
